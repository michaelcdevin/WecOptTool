<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial 1 - WaveBot &mdash; WecOptTool 2.4.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tutorial 2 - AquaHarmonics" href="tutorial_2_AquaHarmonics.html" />
    <link rel="prev" title="Tutorials" href="../tutorials.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            WecOptTool
          </a>
              <div class="version">
                2.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../theory.html">Theory &amp; Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../implementation.html">Implementation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Tutorial 1 - WaveBot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#1.-Optimal-control-for-maximum-mechanical-power">1. Optimal control for maximum mechanical power</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#WEC-object">WEC object</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#Mesh">Mesh</a></li>
<li class="toctree-l5"><a class="reference internal" href="#BEM">BEM</a></li>
<li class="toctree-l5"><a class="reference internal" href="#PTO">PTO</a></li>
<li class="toctree-l5"><a class="reference internal" href="#WEC-creation"><code class="docutils literal notranslate"><span class="pre">WEC</span></code> creation</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#Waves">Waves</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Objective-function">Objective function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Solve">Solve</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Analyzing-results">Analyzing results</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#2.-Optimal-control-for-maximum-electrical-power">2. Optimal control for maximum electrical power</a></li>
<li class="toctree-l3"><a class="reference internal" href="#3.-Control-co-design-of-the-WEC-geometry-for-maximum-electrical-power">3. Control co-design of the WEC geometry for maximum electrical power</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Problem-setup">Problem setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Solve</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Results">Results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_2_AquaHarmonics.html">Tutorial 2 - AquaHarmonics</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_3_LUPA.html">Tutorial 3 - LUPA</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_docs/wecopttool.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">WecOptTool</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Tutorial 1 - WaveBot</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Tutorial-1---WaveBot">
<h1>Tutorial 1 - WaveBot<a class="headerlink" href="#Tutorial-1---WaveBot" title="Permalink to this heading"></a></h1>
<p>The goal of this tutorial is to familiarize new users with how to set up and run optimization problems using WecOptTool. It uses a one-body WEC, the WaveBot, in one degree of freedom in regular waves.</p>
<p><img alt="WaveBot Photo" src="https://live.staticflickr.com/65535/51855905347_de87ccaaba_z.jpg" /></p>
<p>At the end of this tutorial the user will perform control co-design of the WEC’s geometry and a corresponding optimal controller to maximize electrical power. We build up to this problem in three parts of successive complexity:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="#1.-Optimal-control-for-maximum-mechanical-power">Optimal control for maximum mechanical power</a></p></li>
<li><p><a class="reference external" href="#2.-Optimal-control-for-maximum-electrical-power">Optimal control for maximum electrical power</a></p></li>
<li><p><a class="reference external" href="#3.-Control-co-design-of-the-WEC-geometry-for-maximum-electrical-power">Control co-design of the WEC’s geometry for maximum electrical power</a></p></li>
</ol>
<p>We will start by loading the necessary modules:</p>
<ul class="simple">
<li><p>Import Autograd (wrapper on NumPy, required) for automatic differentiation</p></li>
<li><p>Import other packages we will use in this tutorial</p></li>
<li><p>Import WecOptTool</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span> <span class="nn">autograd.numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">capytaine</span> <span class="k">as</span> <span class="nn">cpy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">brute</span>

<span class="kn">import</span> <span class="nn">wecopttool</span> <span class="k">as</span> <span class="nn">wot</span>
</pre></div>
</div>
</div>
<section id="1.-Optimal-control-for-maximum-mechanical-power">
<h2>1. Optimal control for maximum mechanical power<a class="headerlink" href="#1.-Optimal-control-for-maximum-mechanical-power" title="Permalink to this heading"></a></h2>
<p>This example illustrates how to set up, run, and analyze a basic optimization problem within WecOptTool.</p>
<p>The objective of this example is to <strong>find the optimal PTO force time-series</strong> that produces the most mechanical power subject to the WEC dynamics and a maximum force the PTO can exert.</p>
<p>WecOptTool requires the following to be defined to successfully run its optimization routines: - The WEC object, including all of its properties and constraints - The wave condition - The objective function</p>
<div><p><img alt="1adcb5ecd5da441581634ada7a3692df" class="no-scaled-link" src="https://live.staticflickr.com/65535/52435098523_37d6a2ca94_k.jpg" style="width: 1000px;" /></p>
</div><p>The graphic shows all the requirements for this first part of the tutorial: from the wave on the left, to the objective (mechanical power) on the right. The WEC object, with all it’s components, is illustrated in the middle. The components inside the blue box are the WEC properties that are actually passed on to the optimizer. In short, the WEC’s hydrodynamic properties are modelled by 1. Defining the WEC’s geometry 2. Meshing the geometry 3. Obtaining the WEC’s BEM cofficients based on the mesh
4. Determening the WEC’s intrinsic impedance model based on the BEM coefficients</p>
<p>For this first part of the tutorial, the heave-only, WEC-PTO kinematics are trivial (Unity) and the PTO is assumed to be lossless.</p>
<section id="WEC-object">
<h3>WEC object<a class="headerlink" href="#WEC-object" title="Permalink to this heading"></a></h3>
<p>In this section we will create the <code class="docutils literal notranslate"><span class="pre">WEC</span></code> object, which contains all the information about the WEC and its dynamics. This constitutes the vast majority of the setup required to run WecOptTool.</p>
<p>Our <code class="docutils literal notranslate"><span class="pre">WEC</span></code> object requires information about the mesh, degrees of freedom, mass and hydrostatic properties, linear hydrodynamic coefficients (from a BEM solution), any additional dynamic forces (e.g. PTO force, mooring, non-linear hydrodynamics), and constraints (e.g. maximum PTO extension). In this case, the only additional force will be the PTO force and the only constraint will be a maximum PTO force of <span class="math notranslate nohighlight">\(2,000 N\)</span>.</p>
<section id="Mesh">
<h4>Mesh<a class="headerlink" href="#Mesh" title="Permalink to this heading"></a></h4>
<p>First, we will create a surface mesh for the hull and store it using the <code class="docutils literal notranslate"><span class="pre">FloatingBody</span></code> object from Capytaine. The WaveBot mesh is pre-defined in the <code class="docutils literal notranslate"><span class="pre">wecopttool.geom</span></code> module, so we will call it directly from there. We will only model the heave degree of freedom in this case. Note that the Capytaine <code class="docutils literal notranslate"><span class="pre">from_meshio</span></code> method can also import from other file types (STL, VTK, MSH, etc.)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wb</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">WaveBot</span><span class="p">()</span>  <span class="c1"># use standard dimensions</span>
<span class="n">mesh_size_factor</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># 1.0 for default, smaller to refine mesh</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">mesh_size_factor</span><span class="p">)</span>
<span class="n">fb</span> <span class="o">=</span> <span class="n">cpy</span><span class="o">.</span><span class="n">FloatingBody</span><span class="o">.</span><span class="n">from_meshio</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;WaveBot&quot;</span><span class="p">)</span>
<span class="n">fb</span><span class="o">.</span><span class="n">add_translation_dof</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Heave&quot;</span><span class="p">)</span>
<span class="n">ndof</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">nb_dofs</span>
</pre></div>
</div>
</div>
<p>Next we will add the mass and hydrostatic stiffness properties. If these values are known they can be added directly. Here we will use the fact that the WaveBot is free floating and assume constant density to calculate these properties, which Capytaine can natively perform with the <code class="docutils literal notranslate"><span class="pre">FloatingBody</span></code> created above. For convenience, this functionality has been wrapped in <code class="docutils literal notranslate"><span class="pre">wecopttool.hydrostatics</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stiffness</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">hydrostatics</span><span class="o">.</span><span class="n">stiffness_matrix</span><span class="p">(</span><span class="n">fb</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">mass</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">hydrostatics</span><span class="o">.</span><span class="n">inertia_matrix</span><span class="p">(</span><span class="n">fb</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
<div class="line-block">
<div class="line">At this point we can visualize the mesh for inspection. Capytaine has built-in methods for visualizing meshes (<code class="docutils literal notranslate"><span class="pre">fb.show</span></code>, and <code class="docutils literal notranslate"><span class="pre">fb.show_matplotlib</span></code>). When running outside a Notebook, these are interactive.</div>
<div class="line">The included WaveBot example also has a method for plotting the cross-section of the device.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fb</span><span class="o">.</span><span class="n">show_matplotlib</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">plot_cross_section</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># specific to WaveBot</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/_examples_tutorial_1_WaveBot_8_0.png" src="../_images/_examples_tutorial_1_WaveBot_8_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/_examples_tutorial_1_WaveBot_8_1.png" src="../_images/_examples_tutorial_1_WaveBot_8_1.png" />
</div>
</div>
</section>
<section id="BEM">
<h4>BEM<a class="headerlink" href="#BEM" title="Permalink to this heading"></a></h4>
<p>With our Capytaine floating body created, we can now run the Boundary Element Method solver in Capytaine to get the hydrostatic and hydrodynamic coefficients of our WEC object. This is wrapped into the <code class="docutils literal notranslate"><span class="pre">wecopttool.run_bem</span></code> function.</p>
<p>We will analyze 50 frequencies with a spacing of 0.05 Hz. These frequencies will be used for the Fourier representation of both the wave and the desired PTO force in the pseudo-spectral problem. See the Theory section of the Documentation for more details on the pseudo-spectral problem formulation.</p>
<p>If you would like to save our BEM data to a NetCDF file for future use, see the <code class="docutils literal notranslate"><span class="pre">wecopttool.write_netcdf</span></code> function.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f1</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">nfreq</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">freq</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">frequency</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">nfreq</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># False -&gt; no zero frequency</span>

<span class="n">bem_data</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">run_bem</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=8.796, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=7.97e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=9.111, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=7.43e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=9.425, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=6.94e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=9.739, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=6.50e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=10.053, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=6.10e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=10.367, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=5.73e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=10.681, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=5.40e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=10.996, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=5.10e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=11.310, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=4.82e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=11.624, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=4.56e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=11.938, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=4.32e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=12.252, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=4.11e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=12.566, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.90e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=12.881, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.72e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=13.195, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.54e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=13.509, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.38e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=13.823, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.23e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=14.137, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.08e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=14.451, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=2.95e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=14.765, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=2.83e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=15.080, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=2.71e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=15.394, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=2.60e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for DiffractionProblem(body=WaveBot_immersed, omega=15.708, depth=inf, wave_direction=0.000, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=2.50e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=8.796, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=7.97e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=9.111, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=7.43e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=9.425, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=6.94e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=9.739, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=6.50e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=10.053, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=6.10e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=10.367, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=5.73e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=10.681, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=5.40e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=10.996, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=5.10e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=11.310, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=4.82e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=11.624, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=4.56e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=11.938, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=4.32e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=12.252, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=4.11e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=12.566, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.90e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=12.881, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.72e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=13.195, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.54e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=13.509, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.38e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=13.823, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.23e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=14.137, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=3.08e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=14.451, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=2.95e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=14.765, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=2.83e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=15.080, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=2.71e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=15.394, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=2.60e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
WARNING:capytaine.bem.problems_and_results:Mesh resolution for RadiationProblem(body=WaveBot_immersed, omega=15.708, depth=inf, radiating_dof=Heave, rho=1025.0):
The resolution of the mesh &#39;WaveBot&#39; of the body &#39;WaveBot_immersed&#39; might be insufficient for the wavelength λ=2.50e-01.
This warning appears because the largest panel of this mesh has radius 1.01e-01 &gt; λ/8.
</pre></div></div>
</div>
</section>
<section id="PTO">
<h4>PTO<a class="headerlink" href="#PTO" title="Permalink to this heading"></a></h4>
<p>WecOptTool includes the <code class="docutils literal notranslate"><span class="pre">PTO</span></code> class to encompass all properties of the power take-off system of the WEC. Data wrapped into our <code class="docutils literal notranslate"><span class="pre">PTO</span></code> class will be used to help define our <code class="docutils literal notranslate"><span class="pre">WEC</span></code> object and optimization problem later.</p>
<p>To create an instance of the <code class="docutils literal notranslate"><span class="pre">PTO</span></code> class, we need: - The kinematics matrix, which converts from the WEC degrees of freedom to the PTO degrees of freedom. The PTO extracts power directly from the WEC’s heave in this case, so the kinematics matrix is simply the <span class="math notranslate nohighlight">\(1 \times 1\)</span> identity matrix. - The definition of the PTO controller. The <code class="docutils literal notranslate"><span class="pre">wecopttool.pto</span></code> submodule includes P, PI, and PID controller functions that can be provided to the <code class="docutils literal notranslate"><span class="pre">PTO</span></code> class and return the PTO force. However, we will
be using an unstructured controller in this case, so we will set <code class="docutils literal notranslate"><span class="pre">None</span></code> for the controller. - Any PTO impedance. We’re only interested in mechanical power for this first problem, so we will leave this empty for now - The non-linear power conversion loss (assumed 0% if <code class="docutils literal notranslate"><span class="pre">None</span></code>) - The PTO system name, if desired</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PTO_Heave&quot;</span><span class="p">,]</span>
<span class="n">kinematics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">ndof</span><span class="p">)</span>
<span class="n">controller</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">loss</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">pto_impedance</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">pto</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">pto</span><span class="o">.</span><span class="n">PTO</span><span class="p">(</span><span class="n">ndof</span><span class="p">,</span> <span class="n">kinematics</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">pto_impedance</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now let’s define the PTO forcing on the WEC and the PTO constraints. For our optimization problem, the constraints must be in the correct format for <code class="docutils literal notranslate"><span class="pre">scipy.optimize.minimize()</span></code>. We will enforce the constraint at 4 times more points than the dynamics (see Theory for why this is helpful for the pseudo-spectral problem).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># PTO dynamics forcing function</span>
<span class="n">f_add</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;PTO&#39;</span><span class="p">:</span> <span class="n">pto</span><span class="o">.</span><span class="n">force_on_wec</span><span class="p">}</span>

<span class="c1"># Constraint</span>
<span class="n">f_max</span> <span class="o">=</span> <span class="mf">2000.0</span>
<span class="n">nsubsteps</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">def</span> <span class="nf">const_f_pto</span><span class="p">(</span><span class="n">wec</span><span class="p">,</span> <span class="n">x_wec</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">waves</span><span class="p">):</span> <span class="c1"># Format for scipy.optimize.minimize</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">pto</span><span class="o">.</span><span class="n">force_on_wec</span><span class="p">(</span><span class="n">wec</span><span class="p">,</span> <span class="n">x_wec</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">nsubsteps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f_max</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

<span class="n">ineq_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span>
             <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="n">const_f_pto</span><span class="p">,</span>
             <span class="p">}</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">ineq_cons</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="WEC-creation">
<h4><code class="docutils literal notranslate"><span class="pre">WEC</span></code> creation<a class="headerlink" href="#WEC-creation" title="Permalink to this heading"></a></h4>
<p>We are now ready to create the <code class="docutils literal notranslate"><span class="pre">WEC</span></code> object itself! Since we ran our BEM already, we can define the object using the <code class="docutils literal notranslate"><span class="pre">wecopttool.WEC.from_bem</span></code> function. If we saved our BEM data to a NetCDF file, we can also provide the path to that file instead of specifying the BEM <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> directly.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wec</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">WEC</span><span class="o">.</span><span class="n">from_bem</span><span class="p">(</span>
    <span class="n">bem_data</span><span class="p">,</span>
    <span class="n">inertia_matrix</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span>
    <span class="n">hydrostatic_stiffness</span><span class="o">=</span><span class="n">stiffness</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
    <span class="n">friction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">f_add</span><span class="o">=</span><span class="n">f_add</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:wecopttool.core:Linear damping for DOF &#34;Heave&#34; has negative or close to zero terms. Shifting up via linear friction of 44.029505051539886 N/(m/s).
</pre></div></div>
</div>
<p>Note: We might receive a warning regarding negative linear damping values. Per default, WecOptTool ensures that the BEM data does not contain non-negative damping values. If you would like to correct the BEM solution manually to a minimum damping value you can specify <code class="docutils literal notranslate"><span class="pre">min_damping</span></code>.</p>
</section>
</section>
<section id="Waves">
<h3>Waves<a class="headerlink" href="#Waves" title="Permalink to this heading"></a></h3>
<p>The wave environment must be specified as a 2-dimensional <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> containing the complex amplitude (m). The two coordinates are the radial frequency <code class="docutils literal notranslate"><span class="pre">omega</span></code> (rad/s) and the direction <code class="docutils literal notranslate"><span class="pre">wave_direction</span></code> (rad). The <code class="docutils literal notranslate"><span class="pre">wecopttool.waves</span></code> submodule contains functions for creating this <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> for different types of wave environments.</p>
<p>In this case we will use a regular wave with a frequency of 0.3 Hz and an amplitude of 0.0625 m. We will use the <code class="docutils literal notranslate"><span class="pre">wecopttool.waves.regular_wave</span></code> function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">amplitude</span> <span class="o">=</span> <span class="mf">0.0625</span>
<span class="n">wavefreq</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">phase</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">wavedir</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">waves</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">waves</span><span class="o">.</span><span class="n">regular_wave</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">nfreq</span><span class="p">,</span> <span class="n">wavefreq</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">wavedir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Objective-function">
<h3>Objective function<a class="headerlink" href="#Objective-function" title="Permalink to this heading"></a></h3>
<p>The objective function is the quantity (scalar) we want to optimize—in this case, the average mechanical power. The objective function is itself a function of the optimization state, the size of which we need to properly define our call to <code class="docutils literal notranslate"><span class="pre">scipy.optimize.minimize()</span></code>. The average mechanical power can be taken directly from the <code class="docutils literal notranslate"><span class="pre">PTO</span></code> object we created.</p>
<p>One technical quirk here: <code class="docutils literal notranslate"><span class="pre">nstate_opt</span></code> is one smaller than would be expected for a state space representing the mean (DC) component and the real and imaginary Fourier coefficients. This is because WecOptTool excludes the imaginary Fourier component of the highest frequency (the 2-point wave). Since the 2-point wave is sampled at multiples of <span class="math notranslate nohighlight">\(\pi\)</span>, the imaginary component is evaluated as <span class="math notranslate nohighlight">\(sin(n\pi); n = 0, 1, 2, ..., n_{freq}\)</span>, which is always zero. Excluding this component speeds
up the optimization as the state space is reduced by one.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj_fun</span> <span class="o">=</span> <span class="n">pto</span><span class="o">.</span><span class="n">mechanical_average_power</span>
<span class="n">nstate_opt</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">nfreq</span>
</pre></div>
</div>
</div>
</section>
<section id="Solve">
<h3>Solve<a class="headerlink" href="#Solve" title="Permalink to this heading"></a></h3>
<p>We are now ready to solve the problem. WecOptTool uses <code class="docutils literal notranslate"><span class="pre">scipy.optimize.minimize</span></code> as its optimization driver, which is wrapped into <code class="docutils literal notranslate"><span class="pre">wecopttool.WEC.solve</span></code> for ease of use.</p>
<p>Note that the only required inputs for defining and solving the problem are: (1) the waves, (2) the objective function, and (3) the size of the optimization state. Optional inputs can be provided to control the optimization execution if desired, which we do here to change the default iteration maximum and tolerance. See <code class="docutils literal notranslate"><span class="pre">scipy.optimize.minimize</span></code> docs for more details.</p>
<p>To help the optimization we will scale the problem before solving it (see Documentation). WecOptTool allows you to scale the WEC dynamics state, your optimization state (in this case the Fourier coefficients for the PTO force), and the objective function separately. See the <code class="docutils literal notranslate"><span class="pre">wecopttool.WEC.solve()</span></code> function for more information.</p>
<p>Pay attention to the <code class="docutils literal notranslate"><span class="pre">Exit</span> <span class="pre">mode</span></code>: an exit mode of <span class="math notranslate nohighlight">\(0\)</span> indicates a successful solution. For an easy problem (linear, single Dof, unconstrained, etc.) your iterations shouldn’t need to exceed 100. If they do, try adjusting the scales by orders of magnitude, one at a time.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
<span class="n">scale_x_wec</span> <span class="o">=</span> <span class="mf">1e1</span>
<span class="n">scale_x_opt</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">scale_obj</span> <span class="o">=</span> <span class="mf">1e-2</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">wec</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
    <span class="n">waves</span><span class="p">,</span>
    <span class="n">obj_fun</span><span class="p">,</span>
    <span class="n">nstate_opt</span><span class="p">,</span>
    <span class="n">optim_options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
    <span class="n">scale_x_wec</span><span class="o">=</span><span class="n">scale_x_wec</span><span class="p">,</span>
    <span class="n">scale_x_opt</span><span class="o">=</span><span class="n">scale_x_opt</span><span class="p">,</span>
    <span class="n">scale_obj</span><span class="o">=</span><span class="n">scale_obj</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">opt_mechanical_average_power</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">fun</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Optimal average mechanical power: </span><span class="si">{</span><span class="n">opt_mechanical_average_power</span><span class="si">}</span><span class="s1"> W&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimization terminated successfully    (Exit mode 0)
            Current function value: -1.0114890096147553
            Iterations: 18
            Function evaluations: 18
            Gradient evaluations: 18
Optimal average mechanical power: -101.14890096147553 W
</pre></div></div>
</div>
</section>
<section id="Analyzing-results">
<h3>Analyzing results<a class="headerlink" href="#Analyzing-results" title="Permalink to this heading"></a></h3>
<p>We will use two post-processing functions to obtain frequency- and time-domain results for the WEC and PTO responses. The pseudospectral method gives continuous in time results. To get smoother looking plots, we specify the number of subpoints betweeen co-location points. In this case we will use 5.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nsubsteps</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">pto_fdom</span><span class="p">,</span> <span class="n">pto_tdom</span> <span class="o">=</span> <span class="n">pto</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">wec</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">nsubsteps</span><span class="o">=</span><span class="n">nsubsteps</span><span class="p">)</span>
<span class="n">wec_fdom</span><span class="p">,</span> <span class="n">wec_tdom</span> <span class="o">=</span> <span class="n">wec</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">nsubsteps</span><span class="o">=</span><span class="n">nsubsteps</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">pto.post_process</span></code> function returns <code class="docutils literal notranslate"><span class="pre">xarray.Dataset</span></code>s, which have built-in integration with PyPlot for smart plotting that automagically sets titles and formatting. We will plot the mechanical power (<code class="docutils literal notranslate"><span class="pre">mech_power</span></code>), position (<code class="docutils literal notranslate"><span class="pre">pos</span></code>), and the PTO force (<code class="docutils literal notranslate"><span class="pre">force</span></code>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">pto_tdom</span><span class="p">[</span><span class="s1">&#39;mech_power&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7fbe0ad2d6c0&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/_examples_tutorial_1_WaveBot_27_1.png" src="../_images/_examples_tutorial_1_WaveBot_27_1.png" />
</div>
</div>
<p>We could similarly plot any time- or frequency-domain repsonse of the WEC or PTO. For instance, here is the PTO heave motion.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">wec_tdom</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7fbe05827c10&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/_examples_tutorial_1_WaveBot_29_1.png" src="../_images/_examples_tutorial_1_WaveBot_29_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">pto_tdom</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7fbe058b8640&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/_examples_tutorial_1_WaveBot_30_1.png" src="../_images/_examples_tutorial_1_WaveBot_30_1.png" />
</div>
</div>
<p>Note that there are other dynamic responses available in the post-processed WEC and PTO variables (<code class="docutils literal notranslate"><span class="pre">wec_tdom</span></code>, <code class="docutils literal notranslate"><span class="pre">pto_tdom</span></code>, <code class="docutils literal notranslate"><span class="pre">wec_fdom</span></code>, <code class="docutils literal notranslate"><span class="pre">pto_fdom</span></code>). For example, the time domain PTO variable contains the following response:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pto_tdom</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:     (time: 500, dof: 1)
Coordinates:
  * time        (time) float64 0.0 0.04 0.08 0.12 ... 19.84 19.88 19.92 19.96
  * dof         (dof) &lt;U9 &#x27;PTO_Heave&#x27;
Data variables:
    pos         (time, dof) float64 0.08738 0.09595 0.105 ... 0.07208 0.0794
    vel         (time, dof) float64 0.2073 0.2204 0.2293 ... 0.1745 0.1914
    acc         (time, dof) float64 0.3694 0.2805 0.1578 ... 0.4215 0.4177
    force       (time, dof) float64 1.759e+03 1.86e+03 ... 1.431e+03 1.617e+03
    power       (time, dof) float64 364.7 410.0 441.7 ... 189.7 249.6 309.6
    mech_power  (time, dof) float64 364.7 410.0 441.7 ... 189.7 249.6 309.6
Attributes:
    time_created_utc:  2023-04-26 21:28:23.816499</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-36dd5bab-a42f-404f-8f85-2f4a898a3e9b' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-36dd5bab-a42f-404f-8f85-2f4a898a3e9b' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>time</span>: 500</li><li><span class='xr-has-index'>dof</span>: 1</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-d84a5b31-5b01-4511-bbbc-d8b2c7d2a0b0' class='xr-section-summary-in' type='checkbox'  checked><label for='section-d84a5b31-5b01-4511-bbbc-d8b2c7d2a0b0' class='xr-section-summary' >Coordinates: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.0 0.04 0.08 ... 19.88 19.92 19.96</div><input id='attrs-109da648-8f69-4369-9660-5efd8d615312' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-109da648-8f69-4369-9660-5efd8d615312' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-27f7d85d-a720-4366-93ed-05c29ddffe1e' class='xr-var-data-in' type='checkbox'><label for='data-27f7d85d-a720-4366-93ed-05c29ddffe1e' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>Time</dd><dt><span>units :</span></dt><dd>s</dd></dl></div><div class='xr-var-data'><pre>array([ 0.  ,  0.04,  0.08, ..., 19.88, 19.92, 19.96])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>dof</span></div><div class='xr-var-dims'>(dof)</div><div class='xr-var-dtype'>&lt;U9</div><div class='xr-var-preview xr-preview'>&#x27;PTO_Heave&#x27;</div><input id='attrs-d92b0d98-31c5-4466-b25b-9d0c8bf7d5c9' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-d92b0d98-31c5-4466-b25b-9d0c8bf7d5c9' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-ed2962c2-feae-4a8f-8649-2d081681a239' class='xr-var-data-in' type='checkbox'><label for='data-ed2962c2-feae-4a8f-8649-2d081681a239' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>PTO degree of freedom</dd></dl></div><div class='xr-var-data'><pre>array([&#x27;PTO_Heave&#x27;], dtype=&#x27;&lt;U9&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-dfb9eb9e-78b8-4790-a5c4-c0eeb438faf9' class='xr-section-summary-in' type='checkbox'  checked><label for='section-dfb9eb9e-78b8-4790-a5c4-c0eeb438faf9' class='xr-section-summary' >Data variables: <span>(6)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>pos</span></div><div class='xr-var-dims'>(time, dof)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.08738 0.09595 ... 0.07208 0.0794</div><input id='attrs-a8c4d773-2765-47db-8c29-51fe04180dc9' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-a8c4d773-2765-47db-8c29-51fe04180dc9' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-abd4f42c-b6c3-4d41-8c13-a47a1e247921' class='xr-var-data-in' type='checkbox'><label for='data-abd4f42c-b6c3-4d41-8c13-a47a1e247921' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>Position</dd><dt><span>units :</span></dt><dd>m or rad</dd></dl></div><div class='xr-var-data'><pre>array([[ 0.08738217],
       [ 0.09594944],
       [ 0.10496082],
       [ 0.11422119],
       [ 0.12349502],
       [ 0.13252099],
       [ 0.14102659],
       [ 0.14874155],
       [ 0.15540957],
       [ 0.16079814],
       [ 0.1647066 ],
       [ 0.16697244],
       [ 0.16747625],
       [ 0.16614522],
       [ 0.16295525],
       [ 0.15793165],
       [ 0.15114831],
       [ 0.14272537],
       [ 0.13282565],
       [ 0.12164974],
...
       [-0.08742946],
       [-0.07377268],
       [-0.0600761 ],
       [-0.04661178],
       [-0.03363015],
       [-0.02134852],
       [-0.00994013],
       [ 0.00047536],
       [ 0.00983921],
       [ 0.01815786],
       [ 0.02550322],
       [ 0.03200848],
       [ 0.03785894],
       [ 0.04327837],
       [ 0.04851142],
       [ 0.05380359],
       [ 0.05938061],
       [ 0.06542908],
       [ 0.07208052],
       [ 0.07940026]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>vel</span></div><div class='xr-var-dims'>(time, dof)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.2073 0.2204 ... 0.1745 0.1914</div><input id='attrs-8ce7e984-2ef4-48f5-b5a9-97664611e1e7' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-8ce7e984-2ef4-48f5-b5a9-97664611e1e7' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-62d31bd2-c20f-4fb0-95ca-876f67b3028e' class='xr-var-data-in' type='checkbox'><label for='data-62d31bd2-c20f-4fb0-95ca-876f67b3028e' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>Velocity</dd><dt><span>units :</span></dt><dd>m/s or rad/s</dd></dl></div><div class='xr-var-data'><pre>array([[ 0.20732634],
       [ 0.22044898],
       [ 0.22931396],
       [ 0.23273298],
       [ 0.22987634],
       [ 0.22028604],
       [ 0.20385816],
       [ 0.18080499],
       [ 0.15160783],
       [ 0.11696925],
       [ 0.07776949],
       [ 0.03502837],
       [-0.01012926],
       [-0.05650713],
       [-0.10287256],
       [-0.14799351],
       [-0.19067648],
       [-0.22980276],
       [-0.26436104],
       [-0.29347519],
...
       [ 0.33857789],
       [ 0.34308601],
       [ 0.34061739],
       [ 0.33156614],
       [ 0.31661793],
       [ 0.29674277],
       [ 0.27317027],
       [ 0.24734479],
       [ 0.22085843],
       [ 0.19536239],
       [ 0.17245963],
       [ 0.15358593],
       [ 0.13988989],
       [ 0.13212544],
       [ 0.13057136],
       [ 0.1349908 ],
       [ 0.14463936],
       [ 0.15832394],
       [ 0.17450669],
       [ 0.19144166]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>acc</span></div><div class='xr-var-dims'>(time, dof)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.3694 0.2805 ... 0.4215 0.4177</div><input id='attrs-16980d39-7ebd-4c05-a0c4-1949731c2f42' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-16980d39-7ebd-4c05-a0c4-1949731c2f42' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-75bacc2e-d1d0-41ae-9f0d-51f3bae07cfb' class='xr-var-data-in' type='checkbox'><label for='data-75bacc2e-d1d0-41ae-9f0d-51f3bae07cfb' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>Acceleration</dd><dt><span>units :</span></dt><dd>m/s^2 or rad/s^2</dd></dl></div><div class='xr-var-data'><pre>array([[ 0.36936539],
       [ 0.28049646],
       [ 0.15778027],
       [ 0.00970873],
       [-0.15444136],
       [-0.32549012],
       [-0.49499894],
       [-0.65563419],
       [-0.80127823],
       [-0.92696741],
       [-1.02875678],
       [-1.1035985 ],
       [-1.14928428],
       [-1.16445756],
       [-1.14866435],
       [-1.10239514],
       [-1.02707824],
       [-0.92501045],
       [-0.79924332],
       [-0.65346721],
...
       [ 0.20139942],
       [ 0.02445551],
       [-0.14624748],
       [-0.30345529],
       [-0.43990327],
       [-0.54871297],
       [-0.62386582],
       [-0.66073743],
       [-0.65665528],
       [-0.6114175 ],
       [-0.52768727],
       [-0.41116626],
       [-0.27046008],
       [-0.11658349],
       [ 0.03788944],
       [ 0.17995599],
       [ 0.2974568 ],
       [ 0.38030642],
       [ 0.42149204],
       [ 0.41768333]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>force</span></div><div class='xr-var-dims'>(time, dof)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.759e+03 1.86e+03 ... 1.617e+03</div><input id='attrs-33f01ce1-1bfb-4a4f-936e-5f92f9dae3b8' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-33f01ce1-1bfb-4a4f-936e-5f92f9dae3b8' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-1cf84aeb-63c8-482a-a73a-ce3c107e9aff' class='xr-var-data-in' type='checkbox'><label for='data-1cf84aeb-63c8-482a-a73a-ce3c107e9aff' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>Force or moment on WEC</dd><dt><span>units :</span></dt><dd>N or Nm</dd></dl></div><div class='xr-var-data'><pre>array([[ 1759.21159491],
       [ 1859.9357256 ],
       [ 1926.22198606],
       [ 1965.97212336],
       [ 1987.11374989],
       [ 1996.58886059],
       [ 1999.74288258],
       [ 2000.15068401],
       [ 1999.81000367],
       [ 1999.56051169],
       [ 1999.5641548 ],
       [ 1999.70934728],
       [ 1999.86267644],
       [ 1999.96269959],
       [ 2000.0061322 ],
       [ 2000.        ],
       [ 1999.93994527],
       [ 1999.83438382],
       [ 1999.74586405],
       [ 1999.78650252],
...
       [-2000.        ],
       [-1995.879511  ],
       [-1984.29342669],
       [-1960.62405086],
       [-1919.37629787],
       [-1854.48922229],
       [-1759.81635945],
       [-1629.7746609 ],
       [-1460.12505181],
       [-1248.79963543],
       [ -996.64446669],
       [ -707.91967381],
       [ -390.40583358],
       [  -55.01442008],
       [  285.11362319],
       [  615.93063992],
       [  924.03501602],
       [ 1198.19537731],
       [ 1430.57529627],
       [ 1617.43770608]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>power</span></div><div class='xr-var-dims'>(time, dof)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>364.7 410.0 441.7 ... 249.6 309.6</div><input id='attrs-f7664cf9-74e2-484c-a5cc-4fdded6a813c' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-f7664cf9-74e2-484c-a5cc-4fdded6a813c' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-74f5f67e-8d53-4d2b-8144-ca33ff8113f4' class='xr-var-data-in' type='checkbox'><label for='data-74f5f67e-8d53-4d2b-8144-ca33ff8113f4' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>Power</dd><dt><span>units :</span></dt><dd>W</dd></dl></div><div class='xr-var-data'><pre>array([[ 364.73089934],
       [ 410.02092595],
       [ 441.70959536],
       [ 457.54655931],
       [ 456.79042852],
       [ 439.82065024],
       [ 407.6639131 ],
       [ 361.63721906],
       [ 303.18685224],
       [ 233.88708433],
       [ 155.50509429],
       [  70.04656696],
       [ -20.25713479],
       [-113.01215863],
       [-205.74574833],
       [-295.98702846],
       [-381.34150656],
       [-459.56745954],
       [-528.65490113],
       [-586.88772478],
...
       [-677.15577592],
       [-684.75834255],
       [-675.88485221],
       [-650.07654948],
       [-607.70895835],
       [-550.30626483],
       [-480.72951453],
       [-403.11626815],
       [-322.48093061],
       [-243.96848445],
       [-171.8809383 ],
       [-108.72650234],
       [ -54.61382925],
       [  -7.26880439],
       [  37.22767378],
       [  83.14496899],
       [ 133.65183568],
       [ 189.70301294],
       [ 249.64496478],
       [ 309.64495496]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>mech_power</span></div><div class='xr-var-dims'>(time, dof)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>364.7 410.0 441.7 ... 249.6 309.6</div><input id='attrs-5209c4a6-4f5c-4a61-9663-e8ad32c76303' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-5209c4a6-4f5c-4a61-9663-e8ad32c76303' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-6db6ea21-7e54-415d-99ed-c609f8568043' class='xr-var-data-in' type='checkbox'><label for='data-6db6ea21-7e54-415d-99ed-c609f8568043' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>Mechanical power</dd><dt><span>units :</span></dt><dd>W</dd></dl></div><div class='xr-var-data'><pre>array([[ 364.73089934],
       [ 410.02092595],
       [ 441.70959536],
       [ 457.54655931],
       [ 456.79042852],
       [ 439.82065024],
       [ 407.6639131 ],
       [ 361.63721906],
       [ 303.18685224],
       [ 233.88708433],
       [ 155.50509429],
       [  70.04656696],
       [ -20.25713479],
       [-113.01215863],
       [-205.74574833],
       [-295.98702846],
       [-381.34150656],
       [-459.56745954],
       [-528.65490113],
       [-586.88772478],
...
       [-677.15577592],
       [-684.75834255],
       [-675.88485221],
       [-650.07654948],
       [-607.70895835],
       [-550.30626483],
       [-480.72951453],
       [-403.11626815],
       [-322.48093061],
       [-243.96848445],
       [-171.8809383 ],
       [-108.72650234],
       [ -54.61382925],
       [  -7.26880439],
       [  37.22767378],
       [  83.14496899],
       [ 133.65183568],
       [ 189.70301294],
       [ 249.64496478],
       [ 309.64495496]])</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-61ba4c81-716d-4770-951d-981d6d0d0efc' class='xr-section-summary-in' type='checkbox'  ><label for='section-61ba4c81-716d-4770-951d-981d6d0d0efc' class='xr-section-summary' >Indexes: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>time</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-40ca5181-4ef1-48f1-88b0-85bc0476d913' class='xr-index-data-in' type='checkbox'/><label for='index-40ca5181-4ef1-48f1-88b0-85bc0476d913' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([  0.0,  0.04,  0.08,  0.12,  0.16,   0.2,  0.24,  0.28,  0.32,  0.36,
       ...
        19.6, 19.64, 19.68, 19.72, 19.76,  19.8, 19.84, 19.88, 19.92, 19.96],
      dtype=&#x27;float64&#x27;, name=&#x27;time&#x27;, length=500))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>dof</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-2f30cc74-d408-4f4e-b214-c96d010417a8' class='xr-index-data-in' type='checkbox'/><label for='index-2f30cc74-d408-4f4e-b214-c96d010417a8' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([&#x27;PTO_Heave&#x27;], dtype=&#x27;object&#x27;, name=&#x27;dof&#x27;))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-9b45e41b-cc94-481b-979d-1e2250a56ec6' class='xr-section-summary-in' type='checkbox'  checked><label for='section-9b45e41b-cc94-481b-979d-1e2250a56ec6' class='xr-section-summary' >Attributes: <span>(1)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>time_created_utc :</span></dt><dd>2023-04-26 21:28:23.816499</dd></dl></div></li></ul></div></div></div>
</div>
</section>
</section>
<section id="2.-Optimal-control-for-maximum-electrical-power">
<h2>2. Optimal control for maximum electrical power<a class="headerlink" href="#2.-Optimal-control-for-maximum-electrical-power" title="Permalink to this heading"></a></h2>
<p>The rest of this tutorial will focus on optimizing for electrical power (new objective function) rather than mechanical, as this is a form of power that is usable and transportable.</p>
<p>Since we’re still dealing with the same WaveBot as in part 1, we can reuse the BEM and wave data from before. Look back at part 1 if you need a refresher on how to create these data.</p>
<div><p><img alt="51c7f3e649a341bbbcf159200ad96a7f" class="no-scaled-link" src="https://live.staticflickr.com/65535/52435033525_b8efc28d16_k.jpg" style="width: 1000px;" /></p>
</div><p>The WEC-PTO kinematics remain the same as well (unity). The major difference now is that we consider the dynamics of PTO, since they impact the electrical power and we shall not assume a lossless PTO.</p>
<p>We will express the PTO’s dynamics in form of a 2-port impedance model, to incoporate the dynamics of the drive-train and the dynamics of the generator. The additional mechanical energy storage through the drive-train is modelled using Newton’s second law and we assume a linear generator using a power-invariant park transform.</p>
<p>The PTO impedance matrix components are then obtained under open-circuit conditions, i.e. no load current or no WEC velocity, respectively.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## PTO impedance definition</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">bem_data</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">values</span>
<span class="n">gear_ratio</span> <span class="o">=</span> <span class="mf">12.0</span>
<span class="n">torque_constant</span> <span class="o">=</span> <span class="mf">6.7</span>
<span class="n">winding_resistance</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">winding_inductance</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">drivetrain_inertia</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">drivetrain_friction</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">drivetrain_stiffness</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="n">drivetrain_impedance</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">omega</span><span class="o">*</span><span class="n">drivetrain_inertia</span> <span class="o">+</span>
                        <span class="n">drivetrain_friction</span> <span class="o">+</span>
                        <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">omega</span><span class="p">)</span><span class="o">*</span><span class="n">drivetrain_stiffness</span><span class="p">)</span>

<span class="n">winding_impedance</span> <span class="o">=</span> <span class="n">winding_resistance</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">omega</span><span class="o">*</span><span class="n">winding_inductance</span>


<span class="n">pto_impedance_11</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span> <span class="n">gear_ratio</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">drivetrain_impedance</span>
<span class="n">off_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">torque_constant</span> <span class="o">*</span> <span class="n">gear_ratio</span>
<span class="n">pto_impedance_12</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">off_diag</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">omega</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pto_impedance_21</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">off_diag</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">omega</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pto_impedance_22</span> <span class="o">=</span> <span class="n">winding_impedance</span>
<span class="n">pto_impedance_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pto_impedance_11</span><span class="p">,</span> <span class="n">pto_impedance_12</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">pto_impedance_21</span><span class="p">,</span> <span class="n">pto_impedance_22</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<p>Next, we will create a new <code class="docutils literal notranslate"><span class="pre">PTO</span></code> object with this impedance matrix. We will also update the definitions of our PTO constraint and additional dynamic forcing function to use the new object. We will set our PTO constraint to <span class="math notranslate nohighlight">\(600 N\)</span> for this example, since the dynamics for optimal electrical power will be different.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Update PTO</span>
<span class="n">name_2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PTO_Heave_Ex2&#39;</span><span class="p">]</span>
<span class="n">pto_2</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">pto</span><span class="o">.</span><span class="n">PTO</span><span class="p">(</span><span class="n">ndof</span><span class="p">,</span> <span class="n">kinematics</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">pto_impedance_2</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">name_2</span><span class="p">)</span>

<span class="c1">## Update PTO constraints and forcing</span>
<span class="n">f_max_2</span> <span class="o">=</span> <span class="mf">600.0</span>
<span class="k">def</span> <span class="nf">const_f_pto_2</span><span class="p">(</span><span class="n">wec</span><span class="p">,</span> <span class="n">x_wec</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">waves</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">pto_2</span><span class="o">.</span><span class="n">force_on_wec</span><span class="p">(</span><span class="n">wec</span><span class="p">,</span> <span class="n">x_wec</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">nsubsteps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f_max_2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<span class="n">ineq_cons_2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="n">const_f_pto_2</span><span class="p">}</span>
<span class="n">constraints_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ineq_cons_2</span><span class="p">]</span>
<span class="n">f_add_2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;PTO&#39;</span><span class="p">:</span> <span class="n">pto_2</span><span class="o">.</span><span class="n">force_on_wec</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Finally, let’s update our <code class="docutils literal notranslate"><span class="pre">WEC</span></code> object with the new PTO constraint, then run our optimization problem. Note we’re now using <code class="docutils literal notranslate"><span class="pre">average_power</span></code> instead of <code class="docutils literal notranslate"><span class="pre">mechanical_average_power</span></code> as our objective function.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Update WEC</span>

<span class="n">wec_2</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">WEC</span><span class="o">.</span><span class="n">from_bem</span><span class="p">(</span><span class="n">bem_data</span><span class="p">,</span>
                         <span class="n">inertia_matrix</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span>
                         <span class="n">hydrostatic_stiffness</span><span class="o">=</span><span class="n">stiffness</span><span class="p">,</span>
                         <span class="n">constraints</span><span class="o">=</span><span class="n">constraints_2</span><span class="p">,</span>
                         <span class="n">friction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">f_add</span><span class="o">=</span><span class="n">f_add_2</span>
<span class="p">)</span>

<span class="c1"># Update objective function</span>
<span class="n">obj_fun_2</span> <span class="o">=</span> <span class="n">pto_2</span><span class="o">.</span><span class="n">average_power</span>

<span class="c1"># Solve</span>
<span class="n">scale_x_wec</span> <span class="o">=</span> <span class="mf">1e1</span>
<span class="n">scale_x_opt</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">scale_obj</span> <span class="o">=</span> <span class="mf">1e-2</span>

<span class="n">results_2</span> <span class="o">=</span> <span class="n">wec_2</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
    <span class="n">waves</span><span class="p">,</span>
    <span class="n">obj_fun_2</span><span class="p">,</span>
    <span class="n">nstate_opt</span><span class="p">,</span>
    <span class="n">scale_x_wec</span><span class="o">=</span><span class="n">scale_x_wec</span><span class="p">,</span>
    <span class="n">scale_x_opt</span><span class="o">=</span><span class="n">scale_x_opt</span><span class="p">,</span>
    <span class="n">scale_obj</span><span class="o">=</span><span class="n">scale_obj</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">opt_average_power</span> <span class="o">=</span> <span class="n">results_2</span><span class="o">.</span><span class="n">fun</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Optimal average electrical power: </span><span class="si">{</span><span class="n">opt_average_power</span><span class="si">}</span><span class="s1"> W&#39;</span><span class="p">)</span>

<span class="c1"># Post-process</span>
<span class="n">wec_fdom_2</span><span class="p">,</span> <span class="n">wec_tdom_2</span> <span class="o">=</span> <span class="n">wec_2</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">results_2</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">nsubsteps</span><span class="p">)</span>
<span class="n">pto_fdom_2</span><span class="p">,</span> <span class="n">pto_tdom_2</span> <span class="o">=</span> <span class="n">pto_2</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">wec_2</span><span class="p">,</span> <span class="n">results_2</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">nsubsteps</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:wecopttool.core:Linear damping for DOF &#34;Heave&#34; has negative or close to zero terms. Shifting up via linear friction of 44.029505051539886 N/(m/s).
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.25538946499943743
            Iterations: 13
            Function evaluations: 16
            Gradient evaluations: 13
Optimal average electrical power: -25.538946499943744 W
</pre></div></div>
</div>
<p>We will compare our optimal results to the unconstrained case to gain some insight into the effect of the constraint on the optimal PTO force. Let’s do the same process as before, but unset the <code class="docutils literal notranslate"><span class="pre">constraints</span></code> parameter in a new <code class="docutils literal notranslate"><span class="pre">WEC</span></code> object.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wec_2_nocon</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">WEC</span><span class="o">.</span><span class="n">from_bem</span><span class="p">(</span>
    <span class="n">bem_data</span><span class="p">,</span>
    <span class="n">inertia_matrix</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span>
    <span class="n">hydrostatic_stiffness</span><span class="o">=</span><span class="n">stiffness</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">friction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">f_add</span><span class="o">=</span><span class="n">f_add_2</span><span class="p">)</span>

<span class="n">results_2_nocon</span> <span class="o">=</span> <span class="n">wec_2_nocon</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
    <span class="n">waves</span><span class="p">,</span>
    <span class="n">obj_fun_2</span><span class="p">,</span>
    <span class="n">nstate_opt</span><span class="p">,</span>
    <span class="n">scale_x_wec</span><span class="o">=</span><span class="n">scale_x_wec</span><span class="p">,</span>
    <span class="n">scale_x_opt</span><span class="o">=</span><span class="n">scale_x_opt</span><span class="p">,</span>
    <span class="n">scale_obj</span><span class="o">=</span><span class="n">scale_obj</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">opt_average_power</span> <span class="o">=</span> <span class="n">results_2_nocon</span><span class="o">.</span><span class="n">fun</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Optimal average electrical power: </span><span class="si">{</span><span class="n">opt_average_power</span><span class="si">}</span><span class="s1"> W&#39;</span><span class="p">)</span>
<span class="n">wec_fdom_2_nocon</span><span class="p">,</span> <span class="n">wec_tdom_2_nocon</span> <span class="o">=</span> <span class="n">wec_2_nocon</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span>
    <span class="n">results_2_nocon</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">nsubsteps</span><span class="p">)</span>
<span class="n">pto_fdom_2_nocon</span><span class="p">,</span> <span class="n">pto_tdom_2_nocon</span> <span class="o">=</span> <span class="n">pto_2</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span>
    <span class="n">wec_2_nocon</span><span class="p">,</span> <span class="n">results_2_nocon</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">nsubsteps</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:wecopttool.core:Linear damping for DOF &#34;Heave&#34; has negative or close to zero terms. Shifting up via linear friction of 44.029505051539886 N/(m/s).
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.28895619115706506
            Iterations: 19
            Function evaluations: 22
            Gradient evaluations: 19
Optimal average electrical power: -28.895619115706506 W
</pre></div></div>
</div>
<p>Note that the optimal constrained PTO force follows the optimal unconstrained solution (sinusoidal) whenever the unconstrained solution is within the constraint. When the constraint is active the optimal PTO force is the maximum PTO force of <span class="math notranslate nohighlight">\(600 N\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">wec_tdom_2</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
<span class="n">wec_tdom_2_nocon</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;unconstrained&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">pto_tdom_2</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
<span class="n">pto_tdom_2_nocon</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;unconstrained&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">pto_tdom_2</span><span class="p">[</span><span class="s1">&#39;power&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
<span class="n">pto_tdom_2_nocon</span><span class="p">[</span><span class="s1">&#39;power&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;unconstrained&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7fbe08b6a2f0&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/_examples_tutorial_1_WaveBot_42_1.png" src="../_images/_examples_tutorial_1_WaveBot_42_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/_examples_tutorial_1_WaveBot_42_2.png" src="../_images/_examples_tutorial_1_WaveBot_42_2.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/_examples_tutorial_1_WaveBot_42_3.png" src="../_images/_examples_tutorial_1_WaveBot_42_3.png" />
</div>
</div>
<p>The attentive user might have noticed that the amplitude of the position, force and power signals is about half the magnitude of the signals we plotted in the first part of the tutorial. We can see that optimizing for electrical power requires optimal state trajectories with smaller amplitudes. For most WECs the electrical power is the usable form of power, thus the WEC should be designed for electrical power and we can avoid over-designing, which would results from expecting the forces
associated with the optimal trajectories for mechanical power maximisation.</p>
</section>
<section id="3.-Control-co-design-of-the-WEC-geometry-for-maximum-electrical-power">
<h2>3. Control co-design of the WEC geometry for maximum electrical power<a class="headerlink" href="#3.-Control-co-design-of-the-WEC-geometry-for-maximum-electrical-power" title="Permalink to this heading"></a></h2>
<p>The first two examples only used the inner optimization loop in WecOptTool to optimize PTO power. Here in Part 3 we bring it all together and show how to use both the inner and outer optimization loops in WecOptTool to do control co-optimization of a hull design in conjunction with an optimal controller for electrical power. Again, we use the WaveBot WEC in one degree of freedom in regular waves. The goal is to <strong>find the optimal keel radius</strong> (<code class="docutils literal notranslate"><span class="pre">r2</span></code>) that maximizes the average produced
electrical power, while maintaining a constant hull volume. A constant volume is achieved by setting the height of the conical section (<code class="docutils literal notranslate"><span class="pre">h2</span></code>) in conjunction with the keel radius (<code class="docutils literal notranslate"><span class="pre">r2</span></code>).</p>
<p>This example demonstrates a complete case of the types of optimization studies WecOptTool is meant for. The main optimization (outer optimization loop) is to find the optimal geometry (radius <code class="docutils literal notranslate"><span class="pre">r2</span></code>), and for each geometry considered the optimal PTO force (inner optimization loop) will be found. The inner loop was showcased in Example 2 and uses a gradient-based optimization method, with the gradients obtained with automatic differentiation. The outer loop optimization is for the user to setup.
In this example, we will do a simple <em>brute force</em> optimization using <code class="docutils literal notranslate"><span class="pre">scipy.optimize.brute</span></code>.</p>
<p><img alt="Device Diagram" src="https://live.staticflickr.com/65535/51751577441_515afec334_z.jpg" /></p>
<div><p><img alt="ba77cd7b11e94787813196d16c6bc129" class="no-scaled-link" src="https://live.staticflickr.com/65535/52434071157_187eb4334c_k.jpg" style="width: 1000px;" /></p>
</div><section id="Problem-setup">
<h3>Problem setup<a class="headerlink" href="#Problem-setup" title="Permalink to this heading"></a></h3>
<p>First, we define a function for <code class="docutils literal notranslate"><span class="pre">h2</span></code> based on <code class="docutils literal notranslate"><span class="pre">r1</span></code> that maintains a constant volume. We see that, as expected, smaller values of <code class="docutils literal notranslate"><span class="pre">r2</span></code> require larger values of <code class="docutils literal notranslate"><span class="pre">h2</span></code> in order to maintain a constant hull volume.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r1</span> <span class="o">=</span> <span class="mf">0.88</span>
<span class="n">r2_0</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">h2_0</span> <span class="o">=</span> <span class="mf">0.37</span>
<span class="n">V0</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">h2_0</span><span class="o">*</span><span class="p">(</span><span class="n">r1</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">r2_0</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">r1</span><span class="o">*</span><span class="n">r2_0</span><span class="p">))</span>

<span class="n">r2_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.88</span><span class="o">*</span><span class="mf">0.999</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">h2_from_r2</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V0</span><span class="p">,</span> <span class="n">r1</span><span class="o">=</span><span class="n">r1</span><span class="p">):</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="n">V</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">r1</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">r2</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">r1</span><span class="o">*</span><span class="n">r2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">h2</span>


<span class="c1"># plot</span>
<span class="n">mapres</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">h2_from_r2</span><span class="p">,</span> <span class="n">r2_vals</span><span class="p">)</span>
<span class="n">h2_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapres</span><span class="p">)</span>

<span class="n">fig1</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">r2</span><span class="p">,</span> <span class="n">h2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r2_vals</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">h2_vals</span><span class="p">):</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">WaveBot</span><span class="p">(</span><span class="n">r2</span><span class="o">=</span><span class="n">r2</span><span class="p">,</span> <span class="n">h2</span><span class="o">=</span><span class="n">h2</span><span class="p">,</span> <span class="n">freeboard</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">plot_cross_section</span><span class="p">(</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;r2=</span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, h2=</span><span class="si">{</span><span class="n">h2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;WaveBot hull cross-sections&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/_examples_tutorial_1_WaveBot_46_0.png" src="../_images/_examples_tutorial_1_WaveBot_46_0.png" />
</div>
</div>
<p>Next we will define an objective function for our design optimization problem. We use the same workflow illustrated in Part 2 to set up a WaveBot device and solve for the optimal solution, but wrap this in a function definition which can set <code class="docutils literal notranslate"><span class="pre">r2</span></code> and (indirectly) <code class="docutils literal notranslate"><span class="pre">h2</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">design_obj_fun</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>

    <span class="c1"># Unpack geometry variables</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="n">h2_from_r2</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">r2 = </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>

    <span class="c1"># Set up Capytaine floating body</span>
    <span class="n">wb</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">WaveBot</span><span class="p">(</span><span class="n">r2</span><span class="o">=</span><span class="n">r2</span><span class="p">,</span> <span class="n">h2</span><span class="o">=</span><span class="n">h2</span><span class="p">)</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">mesh_size_factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">fb</span> <span class="o">=</span> <span class="n">cpy</span><span class="o">.</span><span class="n">FloatingBody</span><span class="o">.</span><span class="n">from_meshio</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;WaveBot&quot;</span><span class="p">)</span>
    <span class="n">fb</span><span class="o">.</span><span class="n">add_translation_dof</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Heave&quot;</span><span class="p">)</span>
    <span class="n">ndof</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">nb_dofs</span>

    <span class="c1"># Run BEM</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">nfreq</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">bem_data</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">run_bem</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>

    <span class="c1"># Mass &amp; hydrostatic stiffness</span>
    <span class="n">stiffness_3</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">hydrostatics</span><span class="o">.</span><span class="n">stiffness_matrix</span><span class="p">(</span><span class="n">fb</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">mass_3</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">hydrostatics</span><span class="o">.</span><span class="n">inertia_matrix</span><span class="p">(</span><span class="n">fb</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Impedance definition</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">bem_data</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">values</span>
    <span class="n">gear_ratio</span> <span class="o">=</span> <span class="mf">12.0</span>
    <span class="n">torque_constant</span> <span class="o">=</span> <span class="mf">6.7</span>
    <span class="n">winding_resistance</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">winding_inductance</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">drivetrain_inertia</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">drivetrain_friction</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">drivetrain_stiffness</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">drivetrain_impedance</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">omega</span><span class="o">*</span><span class="n">drivetrain_inertia</span> <span class="o">+</span>
                            <span class="n">drivetrain_friction</span> <span class="o">+</span>
                            <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">omega</span><span class="p">)</span><span class="o">*</span><span class="n">drivetrain_stiffness</span><span class="p">)</span>

    <span class="n">winding_impedance</span> <span class="o">=</span> <span class="n">winding_resistance</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">omega</span><span class="o">*</span><span class="n">winding_inductance</span>


    <span class="n">pto_impedance_11</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span> <span class="n">gear_ratio</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">drivetrain_impedance</span>
    <span class="n">off_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">torque_constant</span> <span class="o">*</span> <span class="n">gear_ratio</span>
    <span class="n">pto_impedance_12</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">off_diag</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">omega</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">pto_impedance_21</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">off_diag</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">omega</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">pto_impedance_22</span> <span class="o">=</span> <span class="n">winding_impedance</span>
    <span class="n">pto_impedance_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pto_impedance_11</span><span class="p">,</span> <span class="n">pto_impedance_12</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">pto_impedance_21</span><span class="p">,</span> <span class="n">pto_impedance_22</span><span class="p">]])</span>

    <span class="c1"># Set PTO object</span>
    <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PTO_Heave&quot;</span><span class="p">,]</span>
    <span class="n">kinematics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">ndof</span><span class="p">)</span>
    <span class="n">efficiency</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pto</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">pto</span><span class="o">.</span><span class="n">PTO</span><span class="p">(</span><span class="n">ndof</span><span class="p">,</span> <span class="n">kinematics</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">pto_impedance_3</span><span class="p">,</span> <span class="n">efficiency</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="c1"># Set PTO constraint and additional dynamic force</span>
    <span class="n">nsubsteps</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">f_max</span> <span class="o">=</span> <span class="mf">600.0</span>

    <span class="k">def</span> <span class="nf">const_f_pto</span><span class="p">(</span><span class="n">wec</span><span class="p">,</span> <span class="n">x_wec</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">waves</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">pto</span><span class="o">.</span><span class="n">force_on_wec</span><span class="p">(</span><span class="n">wec</span><span class="p">,</span> <span class="n">x_wec</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">nsubsteps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f_max</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="n">ineq_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="n">const_f_pto</span><span class="p">}</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">ineq_cons</span><span class="p">]</span>

    <span class="n">f_add</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;PTO&#39;</span><span class="p">:</span> <span class="n">pto</span><span class="o">.</span><span class="n">force_on_wec</span><span class="p">}</span>

    <span class="c1"># Create WEC</span>
    <span class="n">wec</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">WEC</span><span class="o">.</span><span class="n">from_bem</span><span class="p">(</span><span class="n">bem_data</span><span class="p">,</span>
            <span class="n">inertia_matrix</span><span class="o">=</span><span class="n">mass_3</span><span class="p">,</span>
            <span class="n">hydrostatic_stiffness</span><span class="o">=</span><span class="n">stiffness_3</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
            <span class="n">friction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">f_add</span><span class="o">=</span><span class="n">f_add</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Waves</span>
    <span class="n">wfreq</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="mf">0.0625</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="o">-</span><span class="mi">40</span>
    <span class="n">waves_3</span> <span class="o">=</span> <span class="n">wot</span><span class="o">.</span><span class="n">waves</span><span class="o">.</span><span class="n">regular_wave</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">nfreq</span><span class="p">,</span> <span class="n">wfreq</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>

    <span class="c1"># Objective function</span>
    <span class="n">obj_fun</span> <span class="o">=</span> <span class="n">pto</span><span class="o">.</span><span class="n">average_power</span>
    <span class="n">nstate_opt</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">nfreq</span>

    <span class="c1"># Solve</span>
    <span class="n">scale_x_wec</span> <span class="o">=</span> <span class="mf">1e1</span>
    <span class="n">scale_x_opt</span> <span class="o">=</span> <span class="mf">1e-3</span>
    <span class="n">scale_obj</span> <span class="o">=</span> <span class="mf">1e-2</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">wec</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
        <span class="n">waves</span><span class="p">,</span>
        <span class="n">obj_fun</span><span class="p">,</span>
        <span class="n">nstate_opt</span><span class="p">,</span>
        <span class="n">scale_x_wec</span><span class="o">=</span><span class="n">scale_x_wec</span><span class="p">,</span>
        <span class="n">scale_x_opt</span><span class="o">=</span><span class="n">scale_x_opt</span><span class="p">,</span>
        <span class="n">scale_obj</span><span class="o">=</span><span class="n">scale_obj</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">fun</span>
</pre></div>
</div>
</div>
</section>
<section id="id1">
<h3>Solve<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p>Finally, we may call this objective function with an optimization algorithm. Here, a simple <em>brute force</em> optimization approach is used for illustrative purposes, but any variety of options could be applied. The optimization algorithm will call our objective function, which in turn will create a new WaveBot hull, run the necessary BEM calculations for the hull, and find the PTO force that provides the most electric power for that hull. This process will be conducted for the range of <code class="docutils literal notranslate"><span class="pre">r2</span></code>
values that we specify.</p>
<p><em>(note: the cell below will likely take 5+ minutes to run on a standard personal computer)</em></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wot</span><span class="o">.</span><span class="n">set_loglevel</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>  <span class="c1"># Suppress warnings</span>

<span class="c1"># range over which to search</span>
<span class="n">ranges</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">r2_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r2_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">r2_vals</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">r2_vals</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),)</span>

<span class="c1"># solve</span>
<span class="n">opt_x0</span><span class="p">,</span> <span class="n">opt_fval</span><span class="p">,</span> <span class="n">x0s</span><span class="p">,</span> <span class="n">fvals</span> <span class="o">=</span> <span class="n">brute</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">design_obj_fun</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">finish</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

r2 = 0.05:
Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.25516131177847196
            Iterations: 13
            Function evaluations: 16
            Gradient evaluations: 13

r2 = 0.17:
Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.2551002806087916
            Iterations: 12
            Function evaluations: 14
            Gradient evaluations: 12

r2 = 0.29:
Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.2553057613606354
            Iterations: 12
            Function evaluations: 14
            Gradient evaluations: 12

r2 = 0.41:
Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.25547147872919573
            Iterations: 14
            Function evaluations: 14
            Gradient evaluations: 14

r2 = 0.52:
Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.2559469249489439
            Iterations: 13
            Function evaluations: 14
            Gradient evaluations: 13

r2 = 0.64:
Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.2545061178502552
            Iterations: 12
            Function evaluations: 14
            Gradient evaluations: 12

r2 = 0.76:
Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.2528067790143938
            Iterations: 11
            Function evaluations: 15
            Gradient evaluations: 11

r2 = 0.88:
Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.25105733556875914
            Iterations: 11
            Function evaluations: 12
            Gradient evaluations: 11
</pre></div></div>
</div>
</section>
<section id="Results">
<h3>Results<a class="headerlink" href="#Results" title="Permalink to this heading"></a></h3>
<p>From a quick plot of the results, we see that the power absorption (where negative power is power absorbed by the device) generally improves for smaller values of <code class="docutils literal notranslate"><span class="pre">r2</span></code>. It is also clear that when the WEC is cylindrical (where <code class="docutils literal notranslate"><span class="pre">r2=0.88</span></code>), power absorption is reduced.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s1">&#39;color&#39;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">x0s</span><span class="p">)]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x0s</span><span class="p">,</span> <span class="n">fvals</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x0s</span><span class="p">,</span> <span class="n">fvals</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Keel radius, $r_2$ [m]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average Power [W]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Design optimization results&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/_examples_tutorial_1_WaveBot_52_0.png" src="../_images/_examples_tutorial_1_WaveBot_52_0.png" />
</div>
</div>
<p>Note that in this case the magnitude of average power between the different keel radii is rather small, this is because the PTO force constraint is active most of the time, therefore all considered geometries perform similarily. If you remove the PTO constraint and re-run the co-optimization study you will see that the impact of radius on average electrical power is significantly higher.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../tutorials.html" class="btn btn-neutral float-left" title="Tutorials" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tutorial_2_AquaHarmonics.html" class="btn btn-neutral float-right" title="Tutorial 2 - AquaHarmonics" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020 National Technology &amp; Engineering Solutions of Sandia, LLC(NTESS).Under the terms of Contract DE-NA0003525 with NTESS, the U.S. Government retains certain rights in this software..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>